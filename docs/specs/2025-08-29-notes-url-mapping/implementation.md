# 實作計畫

## PRD 參考

**PRD 文件路徑：** `docs/specs/2025-08-29-notes-url-mapping/prd.md`

> **重要提醒：** 實作過程中請經常參考 PRD 文件以了解：
>
> - 功能的商業目標和用戶價值
> - 完整的用戶故事和使用場景
> - 非功能性需求（性能、安全性等）
> - 系統架構和技術決策的背景脈絡

## 相關檔案

- `next.config.ts` - Next.js 設定檔，需要加入靜態輸出設定
- `app/notes/[...slug]/page.tsx` - 動態路由頁面元件（需要建立）
- `lib/notes.ts` - 筆記檔案掃描和處理工具（需要建立）
- `lib/path-utils.ts` - URL 編碼/解碼處理工具（需要建立）
- `app/not-found.tsx` - 404 頁面處理，提供使用者友善的錯誤訊息和導航選項
- `public/notes-src/**/*.md` - 現有的筆記檔案
- `acceptance.feature` - Gherkin 格式的驗收測試場景
- `acceptance-report.md` - 詳細的驗收測試執行報告和問題記錄

## 任務

- [x] 1. 設定 Next.js 靜態輸出模式
  - 1.1 修改 `next.config.ts` 加入 `output: 'export'` 設定
  - 1.2 設定 `trailingSlash: true` 以支援靜態檔案結構
  - 1.3 測試基本的靜態建置功能

- [x] 2. 建立檔案掃描和路由生成工具 - 使用 TDD 開發流程
  - 2.1 實作 `lib/notes.ts` 中的檔案掃描功能，能夠遞迴掃描 `public/notes-src` 目錄
  - 2.2 實作路徑映射邏輯，將檔案路徑轉換為路由參數
  - 2.3 加入中文檔案名稱的處理和驗證
  - 2.4 實作 `generateStaticParams` 函數生成所有靜態路由

- [x] 3. 建立 URL 編碼處理工具 - 使用 TDD 開發流程
  - 3.1 實作 `lib/path-utils.ts` 中的 URL 編碼/解碼功能
  - 3.2 處理中文字符、空格和特殊符號的編碼轉換
  - 3.3 確保 URL 路徑與檔案系統路徑的正確對應
  - 3.4 加入跨平台路徑分隔符處理

- [x] 4. 實作動態筆記頁面元件 - 使用 TDD 開發流程
  - 4.1 建立 `app/notes/[...slug]/page.tsx` 動態路由頁面
  - 4.2 實作筆記內容讀取和純文字顯示邏輯
  - 4.3 加入適當的錯誤處理，包括檔案不存在的情況
  - 4.4 實作頁面標題和基本樣式設定

- [x] 5. 建立 404 頁面處理
  - 5.1 建立或修改 `app/not-found.tsx` 處理不存在的筆記路徑
  - 5.2 設定適當的錯誤頁面樣式和使用者友善訊息
  - 5.3 確保 404 頁面在靜態建置後正常運作

- [x] 6. 執行驗收測試
  - 6.1 使用 AI 讀取 acceptance.feature 檔案
  - 6.2 透過指令或 MCP 瀏覽器操作執行每個場景
  - 6.3 驗證所有場景通過並記錄結果

## Follow-up 修復任務（基於驗收測試結果）

- [x] 7. 深度問題分析和根因調查
  - 7.1 使用 `npm run dev` 啟動開發伺服器 ✅
  - 7.2 使用 MCP 瀏覽器工具重現驗收測試中的失敗場景 ✅
  - 7.3 分析中文檔名 URL 編碼問題的具體原因 ✅
    - 測試 `/notes/20-area/Arlo%20The%20Deer%20%E8%A7%92%E8%89%B2%E8%A8%AD%E5%AE%9A` → 500 錯誤
    - 檢查 URL 解碼過程和檔案路徑對應 → 未處理 URL 編碼版本
    - 查看 `generateStaticParams` 函數的實際執行情況 → 只掃描實際檔案名稱
  - 7.4 分析 404/500 錯誤處理問題的根本原因 ✅
    - 測試 `/notes/non-existent/file` → 500 錯誤而非 404
    - 追蹤錯誤處理的執行路徑 → Next.js 靜態輸出模式限制
    - 理解為什麼觸發 500 而非 404 → `generateStaticParams` 缺少參數錯誤
  - 7.5 檢查和分析程式碼中的實際問題點 ✅
    - 查看 `lib/path-utils.ts` 和 `lib/notes.ts` 的實現 → URL 編碼函數未整合
    - 分析 `generateStaticParams` 和路由處理邏輯 → 未處理不存在路徑
    - 識別需要修改的具體程式碼片段 → `routeParamsToFilePath` 需要 URL 解碼
  - 7.6 制定具體的修復策略和實作計畫 ✅

**問題根因總結：**
1. **核心問題**：`generateStaticParams` 函數缺少參數導致 500 錯誤
2. **中文檔名問題**：URL 編碼版本未在路由生成中處理
3. **錯誤處理問題**：Next.js 靜態模式下不存在路徑觸發 500 而非 404
4. **程式碼整合問題**：`path-utils.ts` 的編碼/解碼函數未在路由處理中使用

**修復順序**：generateStaticParams → URL 編碼整合 → 錯誤處理 → 程式碼品質

- [ ] 8. 修復 generateStaticParams 函數問題
  - 8.1 解決 "missing param in generateStaticParams()" 錯誤
  - 8.2 確保函數只生成存在的檔案路徑
  - 8.3 正確處理不存在路徑的 404 情況，避免 500 錯誤

- [ ] 9. 實作中文檔名 URL 編碼/解碼支援 - 使用 TDD 開發流程
  - 9.1 修復 `lib/path-utils.ts` 中的 URL 編碼/解碼邏輯
  - 9.2 確保 `decodeURIComponent` 正確處理中文字符和空格
  - 9.3 測試各種中文檔名和特殊字符的編碼轉換
  - 9.4 驗證檔案路徑與 URL 路徑的正確對應

- [ ] 10. 修復程式碼品質問題
  - 10.1 解決 `@typescript-eslint/no-explicit-any` 錯誤
  - 10.2 清理未使用的 import (`join`, `notFound`, `sep`, `posix` 等)
  - 10.3 修正未使用的變數警告
  - 10.4 確保 `npm run build` 能成功執行

- [ ] 11. 改善 404 錯誤處理機制
  - 11.1 確保不存在的檔案正確觸發 `notFound()` 而非拋出例外
  - 11.2 驗證自定義 404 頁面在各種錯誤情況下正常顯示
  - 11.3 測試錯誤處理在開發和生產環境的一致性

- [ ] 12. 完善靜態建置功能
  - 12.1 確保所有有效筆記檔案都能生成對應的靜態 HTML
  - 12.2 驗證生成的靜態檔案結構正確
  - 12.3 測試靜態版本中的中文檔名和錯誤處理功能

- [ ] 13. 執行最終驗收測試
  - 13.1 修復所有問題後重新執行完整驗收測試
  - 13.2 確認所有原本失敗的場景現在都能通過
  - 13.3 驗證中文檔名、404 處理、靜態建置等關鍵功能正常運作
  - 13.4 更新驗收報告記錄修復後的測試結果